// ë¬¸ì„œ ìŠ¤íƒ€ì¼ í†µí•©ê¸° ë©”ì¸ ì»´í¬ë„ŒíŠ¸
import React, { useCallback, useRef, useState } from 'react';
import { useDocumentMerger } from '../hooks/useDocumentMerger';
import { ElementStyle } from '../types';
import './DocumentMerger.css';

export function DocumentMerger() {
  const {
    documents,
    mainDocument,
    extractedStyle,
    settings,
    isProcessing,
    progress,
    error,
    addDocuments,
    setMainDocument,
    reorderDocuments,
    removeDocument,
    updateSettings,
    updateStyle,
    processDocuments,
    reset,
  } = useDocumentMerger();

  const fileInputRef = useRef<HTMLInputElement>(null);
  const [dragOver, setDragOver] = useState(false);
  const [showStyleEditor, setShowStyleEditor] = useState(false);
  const [downloadLinks, setDownloadLinks] = useState<{ url: string; filename: string }[]>([]);

  // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      addDocuments(e.target.files);
    }
  }, [addDocuments]);

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragOver(true);
  }, []);

  const handleDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragOver(false);
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragOver(false);

    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      addDocuments(e.dataTransfer.files);
    }
  }, [addDocuments]);

  // ì²˜ë¦¬ ì‹¤í–‰
  const handleProcess = useCallback(async () => {
    const results = await processDocuments();

    // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
    const links = results.map(result => ({
      url: URL.createObjectURL(result.blob),
      filename: result.filename,
    }));

    setDownloadLinks(links);
  }, [processDocuments]);

  // ë‹¤ìš´ë¡œë“œ
  const handleDownload = useCallback((url: string, filename: string) => {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }, []);

  // ëª¨ë‘ ë‹¤ìš´ë¡œë“œ
  const handleDownloadAll = useCallback(() => {
    downloadLinks.forEach(link => {
      handleDownload(link.url, link.filename);
    });
  }, [downloadLinks, handleDownload]);

  // íŒŒì¼ ì•„ì´ì½˜ ë°˜í™˜
  const getFileIcon = (type: string) => {
    switch (type) {
      case 'docx': return 'ğŸ“„';
      case 'pdf': return 'ğŸ“•';
      case 'txt': return 'ğŸ“';
      default: return 'ğŸ“';
    }
  };

  return (
    <div className="document-merger">
      <div className="merger-header">
        <h2>ğŸ“‘ ë¬¸ì„œ ìŠ¤íƒ€ì¼ í†µí•©ê¸°</h2>
        <p>ë©”ì¸ ë¬¸ì„œì˜ ìŠ¤íƒ€ì¼ì„ ë‹¤ë¥¸ ë¬¸ì„œë“¤ì— ì ìš©í•©ë‹ˆë‹¤</p>
      </div>

      {/* ì—ëŸ¬ í‘œì‹œ */}
      {error && (
        <div className="merger-error">
          <span>âš ï¸ {error}</span>
          <button onClick={() => reset()}>ë‹«ê¸°</button>
        </div>
      )}

      {/* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */}
      <div
        className={`upload-zone ${dragOver ? 'drag-over' : ''}`}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        onClick={() => fileInputRef.current?.click()}
      >
        <input
          ref={fileInputRef}
          type="file"
          multiple
          accept=".docx,.pdf,.txt"
          onChange={handleFileSelect}
          style={{ display: 'none' }}
        />
        <div className="upload-content">
          <span className="upload-icon">ğŸ“‚</span>
          <p>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
          <small>ì§€ì› í˜•ì‹: DOCX, PDF, TXT</small>
        </div>
      </div>

      {/* ë¬¸ì„œ ëª©ë¡ */}
      {documents.length > 0 && (
        <div className="documents-section">
          <div className="section-header">
            <h3>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h3>
            <span className="doc-count">{documents.length}ê°œ ë¬¸ì„œ</span>
          </div>

          <div className="documents-list">
            {documents.map((doc, index) => (
              <div
                key={doc.id}
                className={`document-item ${doc.isMainDocument ? 'main-document' : ''}`}
              >
                <div className="doc-info">
                  <span className="doc-icon">{getFileIcon(doc.type)}</span>
                  <span className="doc-name">{doc.name}</span>
                  {doc.isMainDocument && <span className="main-badge">ë©”ì¸</span>}
                </div>

                <div className="doc-actions">
                  {!doc.isMainDocument && (
                    <button
                      className="btn-set-main"
                      onClick={() => setMainDocument(doc.id)}
                      title="ë©”ì¸ ë¬¸ì„œë¡œ ì„¤ì •"
                    >
                      â­
                    </button>
                  )}
                  {index > 0 && (
                    <button
                      className="btn-move"
                      onClick={() => reorderDocuments(index, index - 1)}
                      title="ìœ„ë¡œ ì´ë™"
                    >
                      â†‘
                    </button>
                  )}
                  {index < documents.length - 1 && (
                    <button
                      className="btn-move"
                      onClick={() => reorderDocuments(index, index + 1)}
                      title="ì•„ë˜ë¡œ ì´ë™"
                    >
                      â†“
                    </button>
                  )}
                  <button
                    className="btn-remove"
                    onClick={() => removeDocument(doc.id)}
                    title="ì‚­ì œ"
                  >
                    âœ•
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ì¶”ì¶œëœ ìŠ¤íƒ€ì¼ í‘œì‹œ */}
      {extractedStyle && (
        <div className="style-section">
          <div className="section-header">
            <h3>ğŸ¨ ì¶”ì¶œëœ ìŠ¤íƒ€ì¼</h3>
            <button
              className="btn-edit-style"
              onClick={() => setShowStyleEditor(!showStyleEditor)}
            >
              {showStyleEditor ? 'ë‹«ê¸°' : 'ìˆ˜ì •'}
            </button>
          </div>

          <div className="style-preview">
            <div className="style-item">
              <label>í°íŠ¸</label>
              <span>{extractedStyle.fontFamily}</span>
            </div>
            <div className="style-item">
              <label>í¬ê¸°</label>
              <span>{extractedStyle.fontSize}pt</span>
            </div>
            <div className="style-item">
              <label>ìƒ‰ìƒ</label>
              <span style={{ color: extractedStyle.fontColor }}>
                {extractedStyle.fontColor}
              </span>
            </div>
            <div className="style-item">
              <label>ì •ë ¬</label>
              <span>{extractedStyle.alignment}</span>
            </div>
            <div className="style-item">
              <label>ì¤„ê°„ê²©</label>
              <span>{extractedStyle.lineSpacing}ë°°</span>
            </div>
          </div>

          {/* ìŠ¤íƒ€ì¼ ì—ë””í„° */}
          {showStyleEditor && (
            <StyleEditor style={extractedStyle} onUpdate={updateStyle} />
          )}
        </div>
      )}

      {/* ì¶œë ¥ ì„¤ì • */}
      {documents.length > 1 && (
        <div className="settings-section">
          <h3>âš™ï¸ ì¶œë ¥ ì„¤ì •</h3>

          <div className="setting-group">
            <label>ì¶œë ¥ ë°©ì‹</label>
            <div className="radio-group">
              <label className="radio-label">
                <input
                  type="radio"
                  name="outputMode"
                  checked={settings.outputMode === 'merge'}
                  onChange={() => updateSettings({ outputMode: 'merge' })}
                />
                <span>í•˜ë‚˜ë¡œ ë³‘í•©</span>
              </label>
              <label className="radio-label">
                <input
                  type="radio"
                  name="outputMode"
                  checked={settings.outputMode === 'individual'}
                  onChange={() => updateSettings({ outputMode: 'individual' })}
                />
                <span>ê°œë³„ íŒŒì¼ë¡œ ë³€í™˜</span>
              </label>
            </div>
          </div>

          {settings.outputMode === 'merge' && (
            <div className="setting-group">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={settings.preservePageBreaks}
                  onChange={(e) => updateSettings({ preservePageBreaks: e.target.checked })}
                />
                <span>ë¬¸ì„œ êµ¬ë¶„ í‘œì‹œ ìœ ì§€</span>
              </label>
            </div>
          )}
        </div>
      )}

      {/* ì²˜ë¦¬ ë²„íŠ¼ */}
      {documents.length > 0 && extractedStyle && (
        <div className="action-section">
          {isProcessing ? (
            <div className="progress-container">
              <div className="progress-bar">
                <div className="progress-fill" style={{ width: `${progress}%` }} />
              </div>
              <span className="progress-text">ì²˜ë¦¬ ì¤‘... {progress}%</span>
            </div>
          ) : (
            <button className="btn-process" onClick={handleProcess}>
              ğŸš€ ìŠ¤íƒ€ì¼ ì ìš© ë° ë³€í™˜
            </button>
          )}
        </div>
      )}

      {/* ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ */}
      {downloadLinks.length > 0 && (
        <div className="download-section">
          <div className="section-header">
            <h3>ğŸ“¥ ë‹¤ìš´ë¡œë“œ</h3>
            {downloadLinks.length > 1 && (
              <button className="btn-download-all" onClick={handleDownloadAll}>
                ëª¨ë‘ ë‹¤ìš´ë¡œë“œ
              </button>
            )}
          </div>

          <div className="download-list">
            {downloadLinks.map((link, index) => (
              <div key={index} className="download-item">
                <span className="file-icon">ğŸ“„</span>
                <span className="file-name">{link.filename}</span>
                <button
                  className="btn-download"
                  onClick={() => handleDownload(link.url, link.filename)}
                >
                  ë‹¤ìš´ë¡œë“œ
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ì´ˆê¸°í™” ë²„íŠ¼ */}
      {(documents.length > 0 || downloadLinks.length > 0) && (
        <div className="reset-section">
          <button className="btn-reset" onClick={() => {
            reset();
            setDownloadLinks([]);
          }}>
            ğŸ”„ ìƒˆë¡œ ì‹œì‘
          </button>
        </div>
      )}
    </div>
  );
}

// ìŠ¤íƒ€ì¼ ì—ë””í„° ì»´í¬ë„ŒíŠ¸
function StyleEditor({
  style,
  onUpdate,
}: {
  style: ElementStyle;
  onUpdate: (style: Partial<ElementStyle>) => void;
}) {
  return (
    <div className="style-editor">
      <div className="editor-row">
        <label>í°íŠ¸</label>
        <select
          value={style.fontFamily}
          onChange={(e) => onUpdate({ fontFamily: e.target.value })}
        >
          <option value="Malgun Gothic">ë§‘ì€ ê³ ë”•</option>
          <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
          <option value="Batang">ë°”íƒ•</option>
          <option value="Gulim">êµ´ë¦¼</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
        </select>
      </div>

      <div className="editor-row">
        <label>í¬ê¸° (pt)</label>
        <input
          type="number"
          min="8"
          max="72"
          value={style.fontSize}
          onChange={(e) => onUpdate({ fontSize: Number(e.target.value) })}
        />
      </div>

      <div className="editor-row">
        <label>ìƒ‰ìƒ</label>
        <input
          type="color"
          value={style.fontColor}
          onChange={(e) => onUpdate({ fontColor: e.target.value })}
        />
      </div>

      <div className="editor-row">
        <label>ì •ë ¬</label>
        <select
          value={style.alignment}
          onChange={(e) => onUpdate({ alignment: e.target.value as ElementStyle['alignment'] })}
        >
          <option value="left">ì™¼ìª½</option>
          <option value="center">ê°€ìš´ë°</option>
          <option value="right">ì˜¤ë¥¸ìª½</option>
          <option value="justify">ì–‘ìª½</option>
        </select>
      </div>

      <div className="editor-row">
        <label>ì¤„ê°„ê²©</label>
        <select
          value={style.lineSpacing}
          onChange={(e) => onUpdate({ lineSpacing: Number(e.target.value) })}
        >
          <option value="1">1.0</option>
          <option value="1.15">1.15</option>
          <option value="1.5">1.5</option>
          <option value="2">2.0</option>
        </select>
      </div>

      <div className="editor-row">
        <label>ìŠ¤íƒ€ì¼</label>
        <div className="style-buttons">
          <button
            className={style.bold ? 'active' : ''}
            onClick={() => onUpdate({ bold: !style.bold })}
          >
            <strong>B</strong>
          </button>
          <button
            className={style.italic ? 'active' : ''}
            onClick={() => onUpdate({ italic: !style.italic })}
          >
            <em>I</em>
          </button>
          <button
            className={style.underline ? 'active' : ''}
            onClick={() => onUpdate({ underline: !style.underline })}
          >
            <u>U</u>
          </button>
        </div>
      </div>
    </div>
  );
}
